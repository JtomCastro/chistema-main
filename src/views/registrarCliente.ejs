<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registrar Cliente</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Registrar Nuevo Cliente</h4>
        </div>
        <div class="card-body">
          <% if (mensajeError) { %>
          <div
            class="alert alert-danger alert-dismissible fade show"
            role="alert"
          >
            <%= mensajeError %>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Cerrar"
            ></button>
          </div>
          <% } %> <% if (mensajeExito) { %>
          <div
            class="alert alert-success alert-dismissible fade show"
            role="alert"
          >
            <%= mensajeExito %>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Cerrar"
            ></button>
          </div>
          <% } %>

          <form
            action="/clientes/registrar"
            method="POST"
            class="row g-3"
            id="formRegistrarCliente"
          >
            <div class="col-md-4">
              <label class="form-label">Tipo de Documento *</label>
              <select
                class="form-select"
                name="tipo_documento"
                id="tipo_documento"
                required
              >
                <option value="">Seleccione</option>
                <option value="DNI">DNI</option>
                <option value="RUC">RUC</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label">N√∫mero de Documento *</label>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  name="numero_documento"
                  id="numero_documento"
                  required
                />
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="consultarAPI()"
                >
                  Consultar RENIEC/SUNAT
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Nombres *</label>
              <input
                type="text"
                class="form-control"
                name="nombres"
                id="nombres"
                required
              />
            </div>

            <div class="col-md-4">
              <label class="form-label">Apellido Paterno *</label>
              <input
                type="text"
                class="form-control"
                name="apellido_paterno"
                id="apellido_paterno"
                required
              />
            </div>

            <div class="col-md-4">
              <label class="form-label">Apellido Materno *</label>
              <input
                type="text"
                class="form-control"
                name="apellido_materno"
                id="apellido_materno"
                required
              />
            </div>

            <input
              type="hidden"
              name="codigo_verificacion"
              id="codigo_verificacion"
            />

            <div class="col-md-6">
              <label class="form-label">Direcci√≥n</label>
              <input
                type="text"
                class="form-control"
                name="direccion"
                id="direccion"
              />
            </div>

            <div class="col-md-6">
              <label class="form-label">Tel√©fono</label>
              <input
                type="text"
                class="form-control"
                name="telefono"
                id="telefono"
              />
            </div>

            <div class="col-md-6">
              <label class="form-label">Correo Electr√≥nico</label>
              <input
                type="email"
                class="form-control"
                name="email"
                id="email"
              />
            </div>

            <div class="col-12 d-flex justify-content-between mt-3">
              <button type="submit" class="btn btn-success">
                ‚ûï Registrar Cliente
              </button>
              <a href="/deshboard" class="btn btn-outline-secondary">
                ‚¨Ö Volver al Dashboard
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      async function consultarAPI() {
        const numero = document.getElementById("numero_documento").value.trim();
        const tipo = document.getElementById("tipo_documento").value;

        if (!numero || !tipo) {
          return Swal.fire(
            "üîî",
            "Completa tipo y n√∫mero de documento.",
            "warning"
          );
        }

        // Primero validar si cliente ya est√° registrado
        try {
          const existeResp = await fetch("/clientes/validar-existencia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ numero }),
          });

          const existeData = await existeResp.json();

          if (existeData.success) {
            // Cliente existe en sistema: mostrar alerta y llenar campos
            Swal.fire({
              icon: "info",
              title: "Cliente ya registrado",
              html: `<b>${existeData.cliente.nombres} ${existeData.cliente.apellido_paterno} ${existeData.cliente.apellido_materno}</b><br>N√∫mero: ${existeData.cliente.numero_documento}`,
              confirmButtonText: "Ir a ventas",
            }).then(() => {
              // Redirige a la p√°gina de ventas (ajusta esta ruta si es necesario)
              window.location.href = "/ventas";
            });

            // Llenar campos con datos del cliente registrado
            document.getElementById("nombres").value =
              existeData.cliente.nombres || "";
            document.getElementById("apellido_paterno").value =
              existeData.cliente.apellido_paterno || "";
            document.getElementById("apellido_materno").value =
              existeData.cliente.apellido_materno || "";
            document.getElementById("codigo_verificacion").value =
              existeData.cliente.codigo_verificacion || "";

            // Ya que el cliente est√° registrado, NO llamar a RENIEC
            return;
          }
        } catch (error) {
          console.error("Error al validar existencia:", error);
          return Swal.fire(
            "Error",
            "No se pudo validar si el cliente ya est√° registrado.",
            "error"
          );
        }

        // Si no existe en sistema y es DNI, llamar a RENIEC para traer datos
        if (tipo === "DNI") {
          try {
            const response = await fetch("/clientes/reniec", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ numero }),
            });

            const data = await response.json();

            if (data.success) {
              document.getElementById("nombres").value =
                data.datos.nombres || "";
              document.getElementById("apellido_paterno").value =
                data.datos.apellido_paterno || "";
              document.getElementById("apellido_materno").value =
                data.datos.apellido_materno || "";
              document.getElementById("codigo_verificacion").value =
                data.datos.codigo_verificacion || "";

              Swal.fire("‚úÖ", "Datos obtenidos desde RENIEC.", "success");
            } else {
              Swal.fire("‚ùå", "No se encontraron datos para ese DNI.", "error");
            }
          } catch (error) {
            console.error("Error al consultar RENIEC:", error);
            Swal.fire("‚ö†", "Ocurri√≥ un error al consultar RENIEC.", "error");
          }
        } else {
          Swal.fire("‚Ñπ", "Consulta a SUNAT a√∫n no implementada.", "info");
        }
      }
    </script>
  </body>
</html>
