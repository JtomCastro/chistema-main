<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registrar Nuevo Producto</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }
      .preview-image {
        max-width: 150px;
        max-height: 150px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="form-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="text-primary">âž• Registrar Nuevo Producto</h1>
          <a href="/productos" class="btn btn-outline-secondary"
            >ðŸ”™ Volver al Listado</a
          >
        </div>

        <!-- ðŸŸ¢ CategorÃ­as y Productos -->
        <div class="mb-4 border rounded p-3 bg-light">
          <h5 class="text-success mb-3">
            <i class="bi bi-tags-fill"></i> CategorÃ­as y Productos Registrados
          </h5>
          <div class="row">
            <div class="col-md-6">
              <strong>CategorÃ­as disponibles:</strong>
              <ul class="list-group list-group-flush">
                <% categorias.forEach(cat => { %>
                <li class="list-group-item"><%= cat.nombre %></li>
                <% }) %>
              </ul>
            </div>
            <div class="col-md-6">
              <strong>Algunos productos:</strong>
              <ul class="list-group list-group-flush">
                <% if (productos && productos.length > 0) { %> <%
                productos.slice(0, 5).forEach(prod => { %>
                <li class="list-group-item">
                  <%= prod.nombre %>
                  <small class="text-muted">(Stock: <%= prod.stock %>)</small>
                </li>
                <% }) %> <% } else { %>
                <li class="list-group-item text-muted">
                  No hay productos registrados aÃºn.
                </li>
                <% } %>
              </ul>
            </div>
          </div>
        </div>

        <!-- ðŸŸ  Formulario -->
        <form action="/productos/registrar" method="POST">
          <div class="row g-3">
            <!-- Columna izquierda -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="codigo" class="form-label">CÃ³digo</label>
                <input
                  type="text"
                  class="form-control"
                  id="codigo"
                  name="codigo"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  name="nombre"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="descripcion" class="form-label">DescripciÃ³n</label>
                <textarea
                  class="form-control"
                  id="descripcion"
                  name="descripcion"
                  rows="2"
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="categoria_id" class="form-label">CategorÃ­a</label>
                <select
                  class="form-select"
                  id="categoria_id"
                  name="categoria_id"
                  required
                >
                  <option value="">Seleccione una categorÃ­a</option>
                  <% categorias.forEach(categoria => { %>
                  <option value="<%= categoria.id %>">
                    <%= categoria.nombre %>
                  </option>
                  <% }) %>
                </select>
              </div>

              <div class="mb-3">
                <label for="precio" class="form-label"
                  >Precio de Venta (S/)</label
                >
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="precio"
                  name="precio"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="precio_costo" class="form-label"
                  >Precio de Costo (S/)</label
                >
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="precio_costo"
                  name="precio_costo"
                />
              </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="margen_ganancia" class="form-label"
                  >Margen de Ganancia (%)</label
                >
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="margen_ganancia"
                  name="margen_ganancia"
                />
              </div>

              <div class="mb-3">
                <label for="stock" class="form-label">Stock</label>
                <input
                  type="number"
                  class="form-control"
                  id="stock"
                  name="stock"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="stock_minimo" class="form-label"
                  >Stock MÃ­nimo</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="stock_minimo"
                  name="stock_minimo"
                />
              </div>

              <div class="mb-3">
                <label for="proveedor_id" class="form-label">Proveedor</label>
                <div class="input-group">
                  <select
                    class="form-select"
                    id="proveedor_id"
                    name="proveedor_id"
                  >
                    <option value="">Seleccione un proveedor</option>
                    <% proveedores.forEach(proveedor => { %>
                    <option value="<%= proveedor.id %>">
                      <%= proveedor.razon_social %>
                    </option>
                    <% }) %>
                  </select>
                  <a
                    href="/proveedores/registrar"
                    class="btn btn-outline-primary"
                    >âž•</a
                  >
                </div>
              </div>

              <div class="mb-3">
                <label for="codigo_barras" class="form-label"
                  >CÃ³digo de Barras</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="codigo_barras"
                  name="codigo_barras"
                />
              </div>

              <div class="mb-3">
                <label for="unidad_medida" class="form-label"
                  >Unidad de Medida</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="unidad_medida"
                  name="unidad_medida"
                  placeholder="Ej: kg, litros, unidades"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="imagen" class="form-label"
                  >Imagen del Producto</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="imagen"
                  name="imagen"
                  accept="image/*"
                  onchange="previewImage(event)"
                />
                <div id="imagePreview" class="mt-2"></div>
              </div>
            </div>
          </div>

          <!-- Fila inferior -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select class="form-select" id="estado" name="estado" required>
                  <option value="activo">Activo</option>
                  <option value="inactivo">Inactivo</option>
                  <option value="descontinuado">Descontinuado</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="reset" class="btn btn-secondary me-md-2">
              ðŸ”„ Limpiar
            </button>
            <button type="submit" class="btn btn-primary">
              ðŸ’¾ Guardar Producto
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function previewImage(event) {
        const preview = document.getElementById("imagePreview");
        preview.innerHTML = "";
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview-image img-thumbnail";
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      }

      document
        .getElementById("precio_costo")
        .addEventListener("input", calcularPrecio);
      document
        .getElementById("margen_ganancia")
        .addEventListener("input", calcularPrecio);

      function calcularPrecio() {
        const costo =
          parseFloat(document.getElementById("precio_costo").value) || 0;
        const margen =
          parseFloat(document.getElementById("margen_ganancia").value) || 0;
        if (costo > 0 && margen > 0) {
          const venta = costo * (1 + margen / 100);
          document.getElementById("precio").value = venta.toFixed(2);
        }
      }
    </script>
  </body>
</html>
